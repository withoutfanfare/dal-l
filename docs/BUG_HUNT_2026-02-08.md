# Bug Hunt Report - dalil

Date: 2026-02-08
Scope: `src/`, `src-tauri/src/`, `scripts/`, runtime config

## Executive Summary
- **Top 3 Risks**:
  - Stored/streamed XSS is possible through multiple `v-html` sinks combined with unsanitised markdown/AI output (`CWE-79`).
  - Packaged app startup is likely to fail because the bundled database path is resolved incorrectly in release mode.
  - Keyboard shortcut handling is duplicated for command palette state, which can cause `Cmd/Ctrl+K` to toggle twice and appear broken.
- **Quick Wins**:
  - Add strict HTML sanitisation before every `v-html` render path.
  - Fix release DB path resolution and remove panic-based startup failure.
  - Add request versioning to search and a `finally` reset in updater install flow.

## Issue Register

| ID | Severity | File:Line | Finding | Recommendation | Effort |
|----|----------|-----------|---------|----------------|--------|
| BH-001 | blocker | `src/components/ai/AskResponse.vue:16` | AI response is converted with regex and rendered via `v-html` without sanitisation (XSS, `CWE-79`). | Sanitize rendered HTML (e.g. DOMPurify allowlist) or render markdown with raw HTML disabled. | S |
| BH-002 | blocker | `scripts/build-handbook.ts:131` | Markdown build pipeline enables dangerous HTML and output is injected with `v-html` in document/search views (stored XSS, `CWE-79`). | Disable dangerous HTML in pipeline and/or sanitize at ingest + render. | M |
| BH-003 | blocker | `src-tauri/src/db.rs:17` | Release DB path appends `resources/` under `resource_dir()`, likely resolving to a non-existent location and crashing startup. | Resolve to `resource_dir().join("dalil.db")` and return recoverable error state instead of panic. | S |
| BH-004 | major | `src/composables/useCommandPalette.ts:30` | Global `keydown` handler is registered by multiple consumers (`HomePage` and `CommandPalette`), causing double-toggle behaviour for `Cmd/Ctrl+K`. | Register listener once in a root-level singleton or dedicated provider. | S |
| BH-005 | major | `src/composables/useSearch.ts:47` | Debounced async searches are not sequenced/cancelled; stale responses can overwrite newer query results. | Track request IDs or use abort/cancellation and only apply latest response. | S |
| BH-006 | major | `src/composables/useUpdater.ts:24` | `updating` is set `true` but never reset when `check()` returns `null`, leaving UI stuck in "Installing..." state. | Add `finally { updating.value = false }` and explicit no-update handling branch. | S |
| BH-007 | major | `src/components/content/DocumentView.vue:29` | Anchor links (`#section`) are treated as external and passed to shell `open()`, breaking in-page navigation. | Handle `href.startsWith('#')` as in-page scroll; restrict shell open to allowlisted URL schemes. | S |
| BH-008 | major | `scripts/lib/remark-resolve-links.ts:24` | Relative links containing `#fragment`/`?query` are resolved as file paths and often converted to plain text as "broken links". | Parse URL into pathname + fragment, resolve pathname only, then re-append fragment. | M |
| BH-009 | minor | `src-tauri/src/commands.rs:239` | `ollama_base_url` is merged with `.or(existing...)`, so users cannot clear a previously saved value. | Respect explicit `None` from UI and apply default at read-time instead. | S |
| BH-010 | minor | `src-tauri/src/ai.rs:453` | `cargo clippy --all-targets -- -D warnings` fails on lint errors (`manual_strip`, `needless_borrow`), reducing CI hardening value. | Apply clippy fixes and keep a warnings-as-errors gate in CI. | S |

## Detailed Notes

### BH-001: Unsanitised AI HTML Rendering (CWE-79)
- Evidence:
  - Markdown-like text is transformed with regex into HTML tags: `src/components/ai/AskResponse.vue:16`.
  - Result is directly injected with `v-html`: `src/components/ai/AskResponse.vue:89`.
- Impact:
  - Prompt-injected model output can execute script/HTML in the app context.
  - In Tauri, this risk is amplified by broad app capabilities.

### BH-002: Stored XSS Across Handbook Content Paths (CWE-79)
- Evidence:
  - Build pipeline explicitly allows dangerous HTML: `scripts/build-handbook.ts:131`, `scripts/build-handbook.ts:133`, `scripts/lib/render-markdown.ts:14`, `scripts/lib/render-markdown.ts:16`.
  - Render sinks use `v-html`: `src/components/content/DocumentView.vue:59`, `src/components/search/SearchResult.vue:28`.
- Impact:
  - Malicious content embedded in markdown/docs can run in the desktop app.

### BH-003: Release Database Path Resolution Bug
- Evidence:
  - Release path: `resource_dir().join("resources").join("dalil.db")`: `src-tauri/src/db.rs:17` to `src-tauri/src/db.rs:21`.
  - Bundled resource is declared directly as `../dalil.db`: `src-tauri/tauri.conf.json:40`.
- Impact:
  - Packaged app may fail to locate DB and panic on startup.

### BH-004: Command Palette Shortcut Double Registration
- Evidence:
  - Listener registration in composable: `src/composables/useCommandPalette.ts:30`.
  - Composable consumed in both `src/pages/HomePage.vue:8` and `src/components/search/CommandPalette.vue:11`.
- Impact:
  - Multiple handlers can toggle open/close in one keypress, making shortcut unreliable.

### BH-005: Search Result Race Condition
- Evidence:
  - Async request launched in timeout without cancellation: `src/composables/useSearch.ts:47`.
  - Any returning request writes directly to shared state: `src/composables/useSearch.ts:49`.
- Impact:
  - Fast typing can surface stale results for an older query.

### BH-006: Updater Install State Can Deadlock
- Evidence:
  - `updating` set true: `src/composables/useUpdater.ts:26`.
  - No reset when `check()` yields no update: `src/composables/useUpdater.ts:29` to `src/composables/useUpdater.ts:32`.
- Impact:
  - Notification remains in a disabled "Installing..." state until restart.

### BH-007: Broken Anchor Handling in Document Links
- Evidence:
  - Non-`/` links are opened via shell: `src/components/content/DocumentView.vue:29` to `src/components/content/DocumentView.vue:30`.
- Impact:
  - `#heading` links do not scroll and may trigger external open behaviour.

### BH-008: Fragment/Query Links Incorrectly Degraded
- Evidence:
  - Path resolution includes full URL string: `scripts/lib/remark-resolve-links.ts:24`.
  - Missing slug causes link replacement with plain text: `scripts/lib/remark-resolve-links.ts:31` to `scripts/lib/remark-resolve-links.ts:40`.
- Impact:
  - Valid markdown links with fragments are silently broken during build.

### BH-009: Cannot Clear Saved Ollama URL
- Evidence:
  - Save merge keeps existing value when new value is `None`: `src-tauri/src/commands.rs:239`.
- Impact:
  - UI cannot truly clear provider base URL once stored.

### BH-010: Clippy Gate Fails Under Warnings-as-Errors
- Evidence:
  - `cargo clippy --all-targets -- -D warnings` failed on:
    - `src-tauri/src/ai.rs:453` (`manual_strip`)
    - `src-tauri/src/ai.rs:540` (`manual_strip`)
    - `src-tauri/src/lib.rs:17` (`needless_borrow`)
- Impact:
  - Hardening CI with lint gate currently fails.

## Validation Performed
- `npm run build`: passed.
- `cargo test`: passed (0 tests discovered).
- `cargo clippy --all-targets -- -D warnings`: failed (see BH-010).
- `node --import tsx ./scripts/build-handbook.ts`: passed.

## Notes
- `npm run build:handbook` failed in this sandbox due `tsx` IPC pipe permissions (`EPERM`), but equivalent build succeeded via `node --import tsx`.
